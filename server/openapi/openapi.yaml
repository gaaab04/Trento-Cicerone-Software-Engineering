openapi: 3.0.0
info:
  version: "1.0"
  title: "Trento Cicerone"
  description: API per l'applicazione "Trento Cicerone"
  license:
    name: MIT

servers:
  - url: http://localhost:5001/api
    description: Localhost

paths:

  # --------------------------------------------------------------
  # AUTH
  # --------------------------------------------------------------

  /register:
    post:
      summary: Registrazione utente
      tags: [AuthController]
      description: Registra un nuovo utente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Utente creato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"
              example:
                email: "user@example.com"
                role: "user"
        "400":
          description: Errore di validazione o email già in uso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                emailNonValida:
                  value:
                    message: "Email non valida"
                passwordNonValida:
                  value:
                    message: "Password non valida"
                emailNonDisponibile:
                  value:
                    message: "Email già in uso"
                emailPasswordMancanti:
                  value:
                    message: "Email e password sono obbligatori"
        "500":
          description: Errore interno nel server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: Errore del server
  /login:
    post:
      summary: Login utente
      tags: [AuthController]
      description: Effettua il login dell'utente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Risultato login
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
              example:
                  value:
                    login: true
                    message: "Password corretta"
                    role: "user"
        "404":
          description: Nessuna corrispondenza
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
              example: 
                value:
                  login: false
                  message: "Nessuna corrispondenza trovata"
        "401":
          description: La password non corrisponde
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
              example:
                value:
                  login: false
                  message: "La password non corrisponde"            
        "500":
          description: Errore interno nel server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: Errore del server

  /logout:
    post:
      summary: Logout
      tags: [AuthController]
      description: Effettua il logout dell'utente
      responses:
        "200":
          description: Logout effettuato
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Logout effettuato con successo"

  /refresh:
    post:
      summary: Rinnovo token
      tags: [AuthMiddleware]
      description: Rinnova il token
      parameters:
        - name: refreshToken
          in: cookie
          schema:
            type: string
      responses:
        "200":
          description: Token rinnovato
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  message:
                    type: string
              example:
                valid: true
                message: "Token rinnovato"
        "401":
          description: Token non valido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenErrorResponse"
              examples:
                tokenInvalido:
                  value:
                    valid: false
                    message: "token di rinnovo non valido"
                tokenNonPresente:
                  value:
                    valid: false
                    message: "nessun token di rinnovo presente"

  /protected:
    get:
      security:
        - AccessTokenAuth: []
      summary: Verifica token
      tags: [AuthMiddleware]
      description: Verifica il token di accesso.
      parameters:
        - name: accessToken
          in: cookie
          schema:
            type: string
      responses:
        "401":
          description: Token mancante, non valido, scaduto o utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenErrorResponse"
              examples:
                nessunToken:
                  value:
                    valid: false
                    message: "nessun token di accesso presente"
                tokenNonValido:
                  value:
                    valid: false
                    message: "token non valido o scaduto"
                utenteNonTrovato:
                  value:
                    valid: false
                    message: "utente non trovato"
        "403":
          description: Account sospeso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenErrorResponse"
              example:
                  valid: false
                  message: "L'account è sospeso"


  # --------------------------------------------------------------
  # ADMIN
  # --------------------------------------------------------------

  /admin/operators:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera operatori ed admin
      tags: [AdminController]
      description: Recupera gli operatori e gli admin attualmente attivi
      responses:
        "200":
          description: Lista operatori ed admin
          content:
            application/json:
              schema:
                type: array
                items:
                $ref: "#/components/schemas/UserProfileResponse"
              example:
              - _id: "123456"
                email: "admin1@example.com"
                role: "operator"
              - _id: "789012"
                email: "admin2@example.com"
                role: "admin"
        "500":
          description: "Errore interno del server"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore nel server"

  /admin/promote:
    patch:
      security:
        - AccessTokenAuth: []
      summary: Promuove utente a operatore
      tags: [AdminController]
      description: Promuove un utente al ruolo di operatore, se possibile. 
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
            example:
              email: "utente@example.com"
      responses:
        "200":
          description: Risultato operazione
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PromoteUserResponse"
              example:
                    message: "Utente promosso a operatore"
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PromoteUserResponse"
              example:
                  message: "Utente non trovato"
        "400":
          description: Non promuovibile
          content:
            application/json:
                schema:
                  $ref: "#/components/schemas/PromoteUserResponse"
                example:
                  message: "Non è possibile promuovere un operatore o un admin"
        "500":
          description: Errore interno del server
          content:
            application/json:
                schema:
                  $ref: "#/components/schemas/ErrorResponse"
                example:
                  message: "Errore nel server"

  /admin/demote:
    patch:
      security:
        - AccessTokenAuth: []
      summary: Demote utente da operatore a user
      tags: [AdminController]
      description: Rimuove il ruolo di operatore da un utente, se possibile.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
            example:
              email: "utente@example.com"
      responses:
        "200":
          description: Risultato operazione
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DemoteUserResponse"
              example:
                  message: "Ruolo di operatore rimosso"
        "401":
          description: Impossibile rimuovere il ruolo
          content:
            application/json:
              schema: 
                $ref: "#/components/schemas/DemoteUserResponse"
              examples:
                utente:
                  value:
                    message: "Non è possibile togliere il ruolo di operatore da un utente normale" 
                admin:
                  value:
                    message: "Non è possibile togliere il ruolo di operatore ad un admin"     
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema: 
                $ref: "#/components/schemas/DemoteUserResponse"
              example:
                  message: "Utente non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                  message: "Errore del server"

  # --------------------------------------------------------------
  # ROLE CONTROLLER
  # --------------------------------------------------------------

  /access/public:
    get:
      security:
        - AccessTokenAuth: []
      summary: Accesso pubblico
      tags: [RoleController]
      description: Restituisce informazioni accessibili a chiunque.
      responses:
        "200":
          description: Accesso consentito
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PublicAccessResponse"
              examples:
                accessoConToken:
                  value:
                    message: "Accesso consentito a chiunque"
                    user: "mario.rossi@example.com"
                    role: "user"
                erroreServer:
                  value:
                    message: "Errore del server"

  /access/operator:
    get:
      security:
        - AccessTokenAuth: []
      summary: Accesso operatori e admin
      tags: [RoleController]
      description: Restituisce informazioni accessibili solo a operatori e admin.
      responses:
        "200":
          description: Accesso consentito
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OperatorAccessResponse"
              examples:
                accessoAdmin:
                  value:
                    message: "Accesso consentito a operatori e admin"
                    user: "giulia.bianchi@example.com"
                    role: "admin"
                accessoSenzaToken:
                  value:
                    message: "Errore del server"

  /access/admin:
    get:
      security:
        - AccessTokenAuth: []
      summary: Accesso solo admin
      tags: [RoleController]
      description: Restituisce informazioni accessibili solo agli admin.
      responses:
        "200":
          description: Accesso consentito
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminAccessResponse"
              examples:
                accessoAdmin:
                  value:
                    message: "Accesso consentito solo a admin"
                    user: "giulia.bianchi@example.com"
                    role: "admin"
                accessoSenzaToken:
                  value:
                    message: "Errore del server"

  # --------------------------------------------------------------
  # USER CONTROLLER
  # --------------------------------------------------------------

  /users/me:
    get:
      security:
        - AccessTokenAuth: []
      summary: Profilo utente loggato
      tags: [UserController]
      description: Restituisce il profilo dell'utente autenticato.
      responses:
        "200":
          description: Profilo recuperato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfileResponse"
              example:
                _id: "648d2f5e2f1b3c6b12345678"
                email: "mario.rossi@example.com"
                role: "user"
        "401":
          description: Token mancante o ID utente non presente nel token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Non autorizzato: ID utente non trovato nel token."
        "404":
          description: Utente non trovato nel database
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Profilo utente non trovato nel database."
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore interno del server durante il recupero del profilo."

  /users/changePassword:
    put:
      security:
        - AccessTokenAuth: []
      summary: Cambia password
      tags: [UserController]
      description: Modifica la password dell'utente autenticato. 
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
            example:
              oldPassword: "Password123"
              newPassword: "Password456"
      responses:
        "200":
          description: Password modificata con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChangePasswordResponse"
              example:
                message: "Password modificata con successo"
        "400":
          description: Campi mancanti
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Tutti i campi sono obbligatori"
        "401":
          description: Password vecchia non corretta
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "La password vecchia non coincide con quella registrata. Riprova."
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Utente non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore interno del server durante la modifica della password."

  /users/{id}/suspend:
    patch:
      security:
        - AccessTokenAuth: []
      summary: Sospende usando l'Id
      tags: [UserController]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      description: Sospende un utente specificato dall'id.
      responses:
        "200":
          description: "Utente sospeso"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user:
                    type: object
                    properties:
                      _id:
                        type: string
                      email:
                        type: string
                        format: email
                      suspended:
                        type: boolean
              example:
                message: Utente sospeso con successo
                user:
                  _id: "64f8a2c123abc456def78901"
                  email: "utente@example.com"
                  suspended: true
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "utente non trovato"
        "403":
          description: Impossibile sospendere l'utente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Non puoi sospendere un admin o un operatore"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  /users/{id}/unsuspend:
    patch:
      security:
        - AccessTokenAuth: []
      summary: Riattiva un utente usando l'id.
      tags: [UserController]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      description: Riattiva un utente specificato dall'id.
      responses:
        "200":
          description: "Utente sospeso"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user:
                    type: object
                    properties:
                      _id:
                        type: string
                      email:
                        type: string
                        format: email
                      suspended:
                        type: boolean
              example:
                message: Utente riattivato con successo
                user:
                  _id: "64f8a2c123abc456def78901"
                  email: "utente@example.com"
                  suspended: false
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "utente non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"
                error: "dettagli errore"

  /users/suspend:
    patch:
      security:
        - AccessTokenAuth: []
      summary: Sospende usando la mail
      tags: [UserController]
      description: Sospende un utente specificato dalla mail.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mail:
                  type: string
                  format: email
      responses:
        "200":
          description: "Utente sospeso"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user:
                    type: object
                    properties:
                      _id:
                        type: string
                      email:
                        type: string
                        format: email
                      suspended:
                        type: boolean
              example:
                message: Utente sospeso con successo
                user:
                  _id: "64f8a2c123abc456def78901"
                  email: "utente@example.com"
                  suspended: true
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "utente non trovato"
        "403":
          description: Impossibile sospendere l'utente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Non puoi sospendere un admin o un operatore"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  /users/unsuspend:
    patch:
      security:
        - AccessTokenAuth: []
      summary: Sospende usando la mail
      tags: [UserController]
      description: Riattiva un utente specificato dalla mail.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mail:
                  type: string
                  format: email
      responses:
        "200":
          description: "Utente riattivato con successo"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user:
                    type: object
                    properties:
                      _id:
                        type: string
                      email:
                        type: string
                        format: email
                      suspended:
                        type: boolean
              example:
                message: Utente sospeso con successo
                user:
                  _id: "64f8a2c123abc456def78901"
                  email: "utente@example.com"
                  suspended: false
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "utente non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  /users/suspended:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera gli account sospesi
      tags: [UserController]
      description: Recupera la lista degli utenti sospesi.
      responses:
        "200":
          description: Lista utenti sospesi
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: Numero totale di utenti sospesi
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/UserProfileResponse"
              example:
                total: 2
                users:
                  - _id: "648d2f5e2f1b3c6b12345678"
                    email: "user1@example.com"
                    role: "user"
                  - _id: "648d2f5e2f1b3c6b87654321"
                    email: "user2@example.com"
                    role: "user"
        "500":
          description: "Errore interno del server"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: Errore durante il recupero degli utenti sospesi

  /users/suspicious:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera gli account sospetti
      tags: [UserController]
      description: Recupera la lista degli utenti sospetti.
      parameters:
        - name: maxMessages
          in: query
          required: false
          schema:
            type: integer
        - name: hours
          in: query
          required: false
          schema:
            type: integer
      responses:
        "200":
          description: Lista di utenti con attività sospetta
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  maxMessages:
                    type: integer
                  timeRange:
                    type: string
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/UserProfileResponse"
                example:
                      total: 3
                      maxMessages: 50
                      timeRange: "24h"
                      users:
                        - _id: "648d2f5e2f1b3c6b11111111"
                          email: "utente1@example.com"
                          role: "user"
                        - _id: "648d2f5e2f1b3c6b22222222"
                          email: "utente2@example.com"
                          role: "user"
                        - _id: "648d2f5e2f1b3c6b33333333"
                          email: "utente3@example.com"
                          role: "operator"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  /users/{id}/messages:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera i messaggi di un utente
      tags: [UserController]
      description: Recupera la lista dei messaggi di un utente.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: hours
          in: query
          required: false
          schema:
            type: integer
        - name: limit
          in: query
          required: false
          schema:
            type: integer
      responses:
        "200":
          description: Messaggi dell'utente
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                  email:
                    type: string
                    format: email
                  suspended:
                    type: boolean
                  totalMessages:
                    type: integer
                  timeRange:
                    type: string
                  messages:
                    type: array
                    items:
                      $ref: "#/components/schemas/ChatMessage"
                example:
                  userId: "648d2f5e2f1b3c6b12345678"
                  email: "mario.rossi@example.com"
                  suspended: false
                  totalMessages: 0
                  timeRange: "24h"
                  messages:
        "404":
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Utente non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  # --------------------------------------------------------------
  # DOCUMENT CONTROLLER
  # --------------------------------------------------------------

  /documents:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera documenti
      tags: [DocumentController]
      description: Restituisce tutti i documenti.
      responses:
        "200":
          description: Lista documenti
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Document"
              example:
                - _id: "648d2f5e2f1b3c6b12345678"
                  title: "Documento 1"
                  content: "Contenuto del documento 1"
                  category: "categoria1"
                  embedding: 3
                  metadata:
                    source: "fonte1"
                    lastUpdated: "2025-12-04T12:00:00"
                - _id: "648d2f5e2f1b3c6b87654321"
                  title: "Documento 2"
                  content: "Contenuto del documento 2"
                  category: "categoria2"
                  embedding: 3
                  metadata:
                    source: "fonte2"
                    lastUpdated: "2025-12-04T12:30:00"

        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore nel server"

    post:
      security:
        - AccessTokenAuth: []
      summary: Aggiungi documento
      tags: [DocumentController]
      description: Crea un nuovo documento.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DocumentCreate"
            example:
              title: "NuovoDocumento"
              content: "Contenuto"
              category: "Monumenti"
              source: "Fonte"
      responses:
        "201":
          description: Documento creato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"
              example:
                _id: "648d2f5e2f1b3c6b12345678"
                title: "Nuovo Documento"
                content: "Contenuto"
                category: "categoria"
                metadata:
                  source: "fonte"
                  lastUpdated: "2025-12-04T13:00:00Z"
                  wordCount: 10
                  embeddingModel: "text-embedding-004"
        "400":
          description: Dati mancanti o embedding non valido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                titoloMancante:
                  value:
                    message: "Titolo del documento obbligatorio"
                contenutoMancante:
                  value:
                    message: "Contenuto del documento obbligatorio"
                embeddingNonValido:
                  value:
                    message: "Embedding non valido. Le dimensioni sono errate"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore nel server"
                error: "dettagli errore"

  /documents/{id}:
    patch:
      security:
        - AccessTokenAuth: []
      summary: Aggiorna documento
      tags: [DocumentController]
      description: Aggiorna un documento esistente.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DocumentCreate"
            example:
              title: "NuovoDocumento"
              content: "Contenuto"
              category: "Monumenti"
              source: "Fonte"
      responses:
        "200":
          description: Documento aggiornato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"
              example:
                _id: "648d2f5e2f1b3c6b12345678"
                title: "Nuovo Documento"
                content: "Contenuto"
                category: "categoria"
                source: "fonte"
                metadata:
                    lastUpdated: "2025-12-04T13:00:00Z"
                    wordCount: 10
                    embeddingModel: "text-embedding-004"
        "400":
          description: Embedding non valido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Embedding non valido. Le dimensioni sono errate"
        "404":
          description: Documento non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Documento non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore nel server"

    delete:
      security:
        - AccessTokenAuth: []
      summary: Elimina documento
      tags: [DocumentController]
      description: Elimina un documento esistente.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Documento eliminato
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  deletedDoc:
                    $ref: "#/components/schemas/Document"
              example:
                message: "documento eliminato con successo"
                deletedDoc:
                  _id: "648d2f5e2f1b3c6b12345678"
                  title: "Documento da eliminare"
                  content: "Contenuto"
                  category: "categoria"
                  source: "fonte"
                  metadata:
                    lastUpdated: "2025-12-04T14:00:00Z"
                    wordCount: 50
                    embeddingModel: "text-embedding-004"
        "400":
          description: ID del documento mancante
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "ID del documento obbligatorio"
        "404":
          description: Documento non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Documento non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore nel server"

  /documents/categories:
    get:
      security:
        - AccessTokenAuth: []
      summary: Ottieni categorie
      tags: [DocumentController]
      description: Recupera le categorie dei documenti
      responses:
        "200":
          description: Lista delle categorie
          content:
            application/json:
              schema:
                type: array
                items:
                  properties:
                    name:
                      type: string
              example:
                - name: "Monumenti"
                - name: "Storia"
        "500": 
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore nel server"

  # --------------------------------------------------------------
  # CHAT CONTROLLER
  # --------------------------------------------------------------

  /chat:
    post:
      security:
        - AccessTokenAuth: []
      summary: Invia messaggio
      tags: [ChatController]
      description: Invia un messaggio alla chat e riceve la risposta del bot.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatMessageRequest"
            example:
              sessionId: session-1700000000000
              message: Come si raggiunge Trento?
              useHybrid: false
      responses:
        "200":
          description: Risposta bot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatMessageResponse"
              example:
                messageId: "65a1f2c3e4b0987d12345678"
                response: "Puoi raggiungere Trento in treno da Verona in circa un'ora, oppure in auto tramite l'autostrada A22."
                mainSource: "document_trentino_viaggi"
                sources:
                  - link: "collegamento"
                searchMethod: "vector"
        "400":
          description: Parametri mancanti
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "message e sessionId sono obbligatori"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore interno durante l'invio del messaggio"

  /chat/{sessionId}:
    get:
      security:
        - AccessTokenAuth: []
      summary: Cronologia chat
      tags: [ChatController]
      description: Recupera i messaggi della sessione specificata dall'id.
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Messaggi della sessione
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ChatMessage"
        "400":
          description: SessionId mancante
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "sessionId è obbligatorio"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  /chat/{messageId}/feedback:
    post:
      security:
        - AccessTokenAuth: []
      summary: Aggiungi feedback
      tags: [ChatController]
      description: Aggiunge un feedback al messaggio specificato dall'id.
      parameters:
        - in: path
          name: messageId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FeedbackRequest"
            example: 
              feedback: positive
              comment: "Ottima risposta"
      responses:
        "200":
          description: Feedback aggiunto
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatMessage"
        "400":
          description: Tipo di feedback non valido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "tipo di feedback non valido. deve essere positive o negative"
        "404":
          description: Messaggio non trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "messaggio non trovato"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  /chat/session:
    post:
      security:
        - AccessTokenAuth: []
      summary: Crea sessione
      tags: [ChatController]
      description: Crea una nuova sessione.
      responses:
        "200":
          description: Sessione creata
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
              example:
                sessionId: "session-1700000000000"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  # --------------------------------------------------------------
  # FAQ CONTROLLER
  # --------------------------------------------------------------

  /faqs:
    get:
      security:
        - AccessTokenAuth: []
      summary: "Recupera le FAQs"
      tags: [FaqController]
      description: Recupera la lista delle FAQs.
      responses:
        "200":
          description: Lista FAQ
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FAQ"
              example:
              - question: "Come raggiungere Trento in treno da Verona?"
                category: "Trasporti"
              - question: "Quali musei sono aperti a Trento durante il weekend?"
                category: "Turismo"
              - question: "Dove parcheggiare vicino al centro storico di Trento?"
                category: "Mobilità"
              - question: "Quali sono i principali eventi culturali a Trento?"
                category: "Eventi"
              - question: "Come visitare il Castello del Buonconsiglio?"
                category: "Turismo"
        "500":
          description: Errore del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore durante il recupero delle FAQ."

    post:
      security:
        - AccessTokenAuth: []
      summary: "Inserisce FAQ"
      tags: [FaqController]
      description: Inserisce una nuova FAQ.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FAQCreate"
            example:
              question: "Come si raggiunge il Muse?"
              category: Musei
      responses:
        "201":
          description: FAQ creata con successo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FAQ"
              example:
                question: "Come si ragiunge il Muse"
                category: "Musei"
        "400":
          description: Categoria non valida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Impossibile creare la FAQ. Verifica che il campo 'category' sia valido."
                details: "Mongoose validation error details"
        "401":
          description: Domanda troppo lunga
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Impossibile creare la FAQ. Superato limite 200 caratteri della domanda."
                details: "Mongoose validation error details"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore interno del server"

  /faqs/{id}:
    put:
      security:
        - AccessTokenAuth: []
      summary: "Modifica FAQ"
      tags: [FaqController]
      description: Modifica una FAQ esistente.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FAQUpdate"
            example:
              question: "Come si raggiunge il Muse"
              category: "Musei"
      responses:
        "200":
          description: FAQ aggiornata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FAQ"
              example:
                question: "Come si raggiunge il Muse"
                category: "Musei"
        "400":
          description: Dati non validi
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Dati non validi. Verifica che la categoria sia corretta."
        "401":
          description: Domanda troppo lunga
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "La domanda è troppo lunga. La lunghezza massima consentita è 200 caratteri."
        "404":
          description: FAQ non trovata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "FAQ non trovata"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore interno del server"

    delete:
      security:
        - AccessTokenAuth: []
      summary: "Elimina FAQ"
      tags: [FaqController]
      description: Elimina una FAQ.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: FAQ eliminata
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  deletedId:
                    type: string
              examples:
                eliminata:
                  value:
                    message: "FAQ eliminata con successo"
                    deletedId: "64f7b123abc4567890def123"
        "404":
          description: FAQ non trovata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "FAQ non trovata"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore interno del server"

  /faqs/categories:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera categorie FAQs
      tags: [FaqController]
      description: Recupera la categorie disponibili per le FAQs.
      responses:
        "200":
          description: Recupera le categorie delle FAQs
          content:
            application/json:
              schema:
                type: object
                properties:
                  category:
                    type: string
              example:
                - "Eventi"
                - "Monumenti"
        "500":
          description: "Errore interno del server"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  # --------------------------------------------------------------
  # SERVICE MANAGEMENT CONTROLLER
  # --------------------------------------------------------------

  /service/status:
    get:
      security:
        - AccessTokenAuth: []
      summary: "Recupera lo stato del servizio"
      tags: [ServiceController]
      description: Recupera lo stato del servizio, attivo o disattivato.
      responses:
        "200":
          description: Stato del servizio recuperato
          content:
            application/json:
              schema:
                type: object
                properties:
                  enabled:
                    type: boolean
                  message:
                    type: string
              examples:
                attivo:
                  value:
                    enabled: true
                    message: "Servizio attivo e funzionante"
                disattivato:
                  value:
                    enabled: false
                    message: "Servizio temporaneamente non disponibile"
        "404":
          description: Stato del servizio non trovato
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Stato non trovato"

  /services/enable:
    patch:
      security:
        - AccessTokenAuth: []
      summary: "Attiva il servizio"
      tags: [ServiceController]
      description: Attiva il servizio.
      responses:
        "200":
          description: Servizio abilitato
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Servizio abilitato con successo"
        "500":
          description: Errore nell'abilitare il servizio
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Impossibile abilitare il servizio"

  /services/disable:
    patch:
      security:
        - AccessTokenAuth: []
      summary: "Disattiva il servizio"
      tags: [ServiceController]
      description: Disattiva il servizio.
      responses:
        "200":
          description: Servizio disabilitato
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Servizio disabilitato con successo"
        "500":
          description: Errore nel disabilitare il servizio
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Impossibile disabilitare il servizio"


  # --------------------------------------------------------------
  # DASHBOARD CONTROLLER
  # --------------------------------------------------------------

  /dashboard/feedback/stats:
    get:
      security:
        - AccessTokenAuth: []
      summary: Statistiche feedback
      tags: [DashboardController]
      description: Restituisce le statistiche degli ultimi feedback
      responses:
        "200":
          description: Statistiche ultimi feedback.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FeedbackStatsResponse"
              example:
                positive: 21
                negative: 5
                total: 26
        "500":
          description: "Errore interno del server"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server."

  /dashboard/last-questions/num:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera ultimi messaggi
      tags: [DashboardController]
      description: Restituisce gli ultimi messaggi, il numero di messaggi viene indicato nel parametro.
      parameters:
      - in: path
        name: num
        required: true
        schema:
          type: integer
      responses:
        "200":
          description: Lista ultimi messaggi inviati al chatbot
          content:
            application/json:
              schema:
                $ref:  "#/components/schemas/LastQuestionsResponse"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"

  /dashboard/feedback:
    get:
      security:
        - AccessTokenAuth: []
      summary: Recupera tutti i feedback
      tags: [DashboardController]
      description: Recupera tutti i messaggi con feedback.
      responses:
        "200":
          description: Lista che contiene tutti i feedback
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FeedbackResponse"
        "500":
          description: Errore interno del server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Errore del server"


# --------------------------------------------------------------
# COMPONENTS
# --------------------------------------------------------------

components:

  securitySchemes:
    AccessTokenAuth:
      type: apiKey
      in: cookie
      name: x-access-token

  schemas:
    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    RegisterResponse:
      type: object
      properties:
        email:
          type: string
        role:
          type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    LoginResponse:
      type: object
      properties:
        login:
          type: boolean
        message:
          type: string
        role:
          type: string
          nullable: true

    Document:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        content:
          type: string
        category:
          type: string
        embedding:
          type: number
        metadata:
          type: object
          properties:
            source:
              type: string
            lastUpdated:
              type: string
              format: date-time

    DocumentCreate:
      type: object
      required: [title, content]
      properties:
        title:
          type: string
        content:
          type: string
        category:
          type: string
        source:
          type: string

    ChatMessageRequest:
      type: object
      required: [sessionId, message]
      properties:
        sessionId:
          type: string
        message:
          type: string
        useHybrid:
          type: boolean
          default: false

    ChatMessageResponse:
      type: object
      properties:
        messageId:
          type: string

    FeedbackRequest:
      type: object
      required: [feedback]
      properties:
        feedback:
          type: string
          enum: ["positive", "negative"]
        comment:
          type: string

    FAQ:
      type: object
      properties:
        question:
          type: string
        category:
          type: string

    FAQCreate:
      type: object
      required: [question, answer]
      properties:
        question:
          type: string
        category:
          type: string

    FAQUpdate:
      type: object
      properties:
        question:
          type: string
        category:
          type: string

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
        error:
          type: string
          nullable: true
        details:
          type: string
          nullable: true

    ChatMessage:
      type: object
      properties:
        _id:
          type: string
        sessionId:
          type: string
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        mainSource:
          type: string
          nullable: true
        retrievedDocs:
          type: array
          items:
            type: object
            properties:
              documentId:
                type: string
              relevanceScore:
                type: number
        feedback:
          type: string
          enum: [positive, negative]
          nullable: true
        comment:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    TokenErrorResponse:
      type: object
      properties:
        valid:
          type: boolean
        message:
          type: string

    PromoteUserResponse:
      type: object
      properties:
        message:
          type: string
        error:
          type: string
          nullable: true

    DemoteUserResponse:
      type: object
      properties:
        message:
          type: string
        error:
          type: string
          nullable: true

    PublicAccessResponse:
      type: object
      properties:
        message:
          type: string
        user:
          type: string
          nullable: true
        role:
          type: string
          nullable: true

    OperatorAccessResponse:
      type: object
      properties:
        message:
          type: string
        user:
          type: string
          nullable: true
        role:
          type: string
          nullable: true

    AdminAccessResponse:
      type: object
      properties:
        message:
          type: string
        user:
          type: string
          nullable: true
        role:
          type: string
          nullable: true

    UserProfileResponse:
      type: object
      properties:
        _id:
          type: string
        email:
          type: string
        role:
          type: string

    ChangePasswordRequest:
      type: object
      required:
        - oldPassword
        - newPassword
      properties:
        oldPassword:
          type: string
        newPassword:
          type: string

    ChangePasswordResponse:
      type: object
      properties:
        message:
          type: string

    FeedbackStatsResponse:
      type: object
      properties:
        positive:
          type: integer
        negative:
          type: integer
        total:
          type: integer

    LastQuestionsResponse:
      type: object
      properties:
        questions:
          type: array
          items:
            type: object
            properties:
              sessionId:
                type: string
              role:
                type: string
              content:
                type: string
              retrievedDocs:
                type: array
                items:
                  type: string
              feedback:
                type: string
              comment:
                type: string

    FeedbackResponse:
      type: object
      properties:
        messages:
          type: array
          items:
            type: object
            properties:
              sessionId:
                type: string
              role:
                type: string
              content:
                type: string
              retrivedDocs:
                type: array
                items:
                  type: string
              feedback:
                type: string
              comment:
                type: string